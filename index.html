<!DOCTYPE html>
<html lang="nl">
<head>
<meta charset="UTF-8">
<title>Voorraad Telling ‚Äì Mobielvriendelijk</title>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

<style>
body { font-family: Arial; padding:20px; background:#f4f6f8; }
.card { background:white; padding:15px; border-radius:8px; box-shadow:0 2px 6px rgba(0,0,0,.1); margin-bottom:20px; }
table { width:100%; border-collapse:collapse; margin-top:10px; }
th, td { border:1px solid #ccc; padding:8px; text-align:center; }
th { background:#eee; }
input[type=number] { width:60px; }

/* Kleuren alleen als er iets is ingevuld */
.verplicht { background:#f9f9f9; }
.negatief { background:#ffdddd; }
.positief { background:#ddffdd; }

/* Print vriendelijk */
@media print {
  body { background:white; }
  .card, button, input { display:none; }
  table { width:100%; }
  th, td { border:1px solid #000; }
}
</style>
</head>
<body>

<h2>üì¶ Voorraad Telling ‚Äì Mobielvriendelijk</h2>

<div class="card">
  <h3>1Ô∏è‚É£ Excel importeren</h3>
  <input type="file" id="file" accept=".xlsx,.xls">
</div>

<div class="card">
  <h3>2Ô∏è‚É£ Telling invoeren</h3>
  <table>
    <thead>
      <tr>
        <th>Product</th>
        <th>Verwacht</th>
        <th>Stuks per verpakking</th>
        <th>Volledige verpakkingen</th>
        <th>Losse stuks</th>
        <th>Totaal geteld</th>
        <th>Verschil</th>
      </tr>
    </thead>
    <tbody id="tabel"></tbody>
  </table>
</div>

<div class="card">
  <button onclick="exporteer()">üì§ Export naar Excel</button>
  <button onclick="window.print()">üñ®Ô∏è Printlijst</button>
</div>

<script>
let producten = [];

document.getElementById("file").addEventListener("change", e => {
  const file = e.target.files[0];
  const reader = new FileReader();

  reader.onload = evt => {
    const data = new Uint8Array(evt.target.result);
    const workbook = XLSX.read(data, { type: "array" });
    const sheet = workbook.Sheets[workbook.SheetNames[0]];
    const rows = XLSX.utils.sheet_to_json(sheet);

    producten = rows.map(r => ({
      product: r.Product || r.product || "Onbekend",
      verwacht: Number(r.VerwachteVoorraad || r.verwachtevoorraad || 0),
      perVerpakking: Number(r.StuksPerVerpakking || r.stuksperverpakking || 1),
      verpakkingen: 0,
      losse: 0
    }));

    render();
  };

  reader.readAsArrayBuffer(file);
});

function render() {
  const tb = document.getElementById("tabel");
  tb.innerHTML = "";

  producten.forEach((p, i) => {
    const totaal = p.verpakkingen * p.perVerpakking + p.losse;
    const verschil = totaal - p.verwacht;

    // Alleen kleur als er iets is ingevuld
    let cls = "";
    if(p.verpakkingen > 0 || p.losse > 0){
      cls = verschil < 0 ? "negatief" : verschil > 0 ? "positief" : "verplicht";
    }

    tb.innerHTML += `
      <tr class="${cls}">
        <td>${p.product}</td>
        <td>${p.verwacht}</td>
        <td>${p.perVerpakking}</td>
        <td><input type="number" inputmode="numeric" min="0" value="${p.verpakkingen}" 
            onchange="producten[${i}].verpakkingen=Number(this.value); render();"></td>
        <td><input type="number" inputmode="numeric" min="0" value="${p.losse}" 
            onchange="producten[${i}].losse=Number(this.value); render();"></td>
        <td>${totaal}</td>
        <td>${verschil}</td>
      </tr>`;
  });
}

function exporteer() {
  const wb = XLSX.utils.book_new();

  // Maak JSON voor SheetJS
  const output = producten.map(p => {
    const totaal = p.verpakkingen * p.perVerpakking + p.losse;
    const verschil = totaal - p.verwacht;
    return {
      Product: p.product,
      Verwacht: p.verwacht,
      StuksPerVerpakking: p.perVerpakking,
      VolledigeVerpakkingen: p.verpakkingen,
      LosseStuks: p.losse,
      TotaalGeteld: totaal,
      Verschil: verschil
    };
  });

  const ws = XLSX.utils.json_to_sheet(output, {header:[
    "Product","Verwacht","StuksPerVerpakking","VolledigeVerpakkingen","LosseStuks","TotaalGeteld","Verschil"]});

  // Kolombreedtes
  ws['!cols'] = [
    {wch: 25},{wch: 12},{wch: 18},{wch: 20},{wch: 15},{wch: 15},{wch: 10}
  ];

  // Kleuren in Excel (tekort rood, overschot groen)
  output.forEach((row,i)=>{
    const r = i+2; // +1 voor header
    const diffCell = `G${r}`;
    if(row.Verschil < 0){
      ws[diffCell].s = {fill:{fgColor:{rgb:"FFAAAA"}}};
    } else if(row.Verschil > 0){
      ws[diffCell].s = {fill:{fgColor:{rgb:"AAFFAA"}}};
    }
  });

  XLSX.utils.book_append_sheet(wb, ws, "Telling");
  XLSX.writeFile(wb, "voorraad_telling.xlsx");
}
</script>

</body>
</html>
