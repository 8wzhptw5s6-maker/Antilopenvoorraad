<!DOCTYPE html>
<html lang="nl">
<head>
<meta charset="UTF-8">
<title>Voorraad Telling ‚Äì Mobiel & Calculator</title>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

<style>
body { font-family: Arial; padding:15px; background:#f4f6f8; font-size:16px; }
.card { background:white; padding:15px; border-radius:8px; box-shadow:0 2px 6px rgba(0,0,0,.1); margin-bottom:20px; }
h2,h3 { margin:10px 0; }

/* Tabel mobielvriendelijk */
.table-wrapper { overflow-x:auto; }
table { width:100%; border-collapse:collapse; min-width:600px; }
th, td { border:1px solid #ccc; padding:8px; text-align:center; }
th { background:#eee; position:sticky; top:0; z-index:1; }
input[type=number] { width:60px; font-size:16px; padding:4px; }

/* Kleuren alleen bij ingevulde telling */
.verplicht { background:#f9f9f9; }
.negatief { background:#ffdddd; }
.positief { background:#ddffdd; }

/* Knoppen mobielvriendelijk */
button { font-size:16px; padding:10px 15px; margin:5px 0; width:100%; border-radius:5px; border:none; background:#4CAF50; color:white; cursor:pointer; }
button:hover { background:#45a049; }

/* Calculator knop in tabel */
.calc-btn { font-size:16px; padding:2px 6px; margin-left:2px; width:auto; background:#2196F3; }

/* Print vriendelijk */
@media print {
  body { background:white; font-size:14pt; }
  button, input { display:none; } /* Alleen knoppen en input verbergen */
  .card { box-shadow:none; padding:0; margin:0; }
  .table-wrapper { overflow:visible; }
  table { width:100%; display:table; border-collapse:collapse; }
  th, td { border:1px solid #000; }
}
</style>
</head>
<body>

<h2>üì¶ Voorraad Telling ‚Äì Mobiel & Calculator</h2>

<div class="card">
  <h3>1Ô∏è‚É£ Excel importeren</h3>
  <input type="file" id="file" accept=".xlsx,.xls">
</div>

<div class="card">
  <h3>2Ô∏è‚É£ Telling invoeren</h3>
  <div class="table-wrapper">
    <table>
      <thead>
        <tr>
          <th>Product</th>
          <th>Verwacht</th>
          <th>Stuks per verpakking</th>
          <th>Volledige verpakkingen</th>
          <th>Losse stuks</th>
          <th>Totaal geteld</th>
          <th>Verschil</th>
        </tr>
      </thead>
      <tbody id="tabel"></tbody>
    </table>
  </div>
</div>

<div class="card">
  <button onclick="exporteer()">üì§ Export naar Excel</button>
  <button onclick="window.print()">üñ®Ô∏è Printlijst</button>
</div>

<script>
let producten = [];

document.getElementById("file").addEventListener("change", e => {
  const file = e.target.files[0];
  const reader = new FileReader();

  reader.onload = evt => {
    const data = new Uint8Array(evt.target.result);
    const workbook = XLSX.read(data, { type: "array" });
    const sheet = workbook.Sheets[workbook.SheetNames[0]];
    const rows = XLSX.utils.sheet_to_json(sheet);

    producten = rows.map(r => ({
      product: r.Product || r.product || "Onbekend",
      verwacht: Number(r.VerwachteVoorraad || r.verwachtevoorraad || 0),
      perVerpakking: Number(r.StuksPerVerpakking || r.stuksperverpakking || 1),
      verpakkingen: 0,
      losse: 0
    }));

    render();
  };

  reader.readAsArrayBuffer(file);
});

function render() {
  const tb = document.getElementById("tabel");
  tb.innerHTML = "";

  producten.forEach((p,i) => {
    const totaal = p.verpakkingen * p.perVerpakking + p.losse;
    const verschil = totaal - p.verwacht;

    // Alleen kleur als er iets is ingevuld
    let cls = "";
    if(p.verpakkingen>0 || p.losse>0){
      cls = verschil<0?"negatief":verschil>0?"positief":"verplicht";
    }

    tb.innerHTML += `
      <tr class="${cls}">
        <td>${p.product}</td>
        <td>${p.verwacht}</td>
        <td>${p.perVerpakking}</td>
        <td><input type="number" inputmode="numeric" min="0" value="${p.verpakkingen}" onchange="producten[${i}].verpakkingen=Number(this.value); render();"></td>
        <td>
          <input type="number" inputmode="numeric" min="0" value="${p.losse}" id="losse-${i}" onchange="producten[${i}].losse=Number(this.value); render();">
          <button type="button" class="calc-btn" onclick="calc(${i})">üßÆ</button>
        </td>
        <td>${totaal}</td>
        <td>${verschil}</td>
      </tr>`;
  });
}

// Inline rekenmachine voor losse stuks
function calc(i){
  const huidige = producten[i].losse || 0;
  const expr = prompt("Voer een berekening in voor losse stuks:", huidige);
  if(expr !== null){
    try {
      // eslint-disable-next-line no-eval
      const resultaat = eval(expr);
      if(!isNaN(resultaat)) {
        producten[i].losse = Math.round(resultaat);
        render();
      }
    } catch(e){
      alert("Ongeldige berekening!");
    }
  }
}

function exporteer(){
  const wb = XLSX.utils.book_new();

  const output = producten.map(p=>{
    const totaal = p.verpakkingen*p.perVerpakking+p.losse;
    const verschil = totaal - p.verwacht;
    return {
      Product:p.product,
      Verwacht:p.verwacht,
      StuksPerVerpakking:p.perVerpakking,
      VolledigeVerpakkingen:p.verpakkingen,
      LosseStuks:p.losse,
      TotaalGeteld:totaal,
      Verschil:verschil
    };
  });

  const ws = XLSX.utils.json_to_sheet(output,{header:["Product","Verwacht","StuksPerVerpakking","VolledigeVerpakkingen","LosseStuks","TotaalGeteld","Verschil"]});

  ws['!cols'] = [{wch:25},{wch:12},{wch:18},{wch:20},{wch:15},{wch:15},{wch:10}];

  // Kleuren Excel
  output.forEach((row,i)=>{
    const r=i+2;
    const diffCell=`G${r}`;
    if(row.Verschil<0){ ws[diffCell].s={fill:{fgColor:{rgb:"FFAAAA"}}}; }
    else if(row.Verschil>0){ ws[diffCell].s={fill:{fgColor:{rgb:"AAFFAA"}}}; }
  });

  XLSX.utils.book_append_sheet(wb, ws,"Telling");
  XLSX.writeFile(wb,"voorraad_telling.xlsx");
}
</script>

</body>
</html>
